<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Chat with Patient | Stay on Top of Your Health</title>
        <link rel="icon" href="Icons/Chat icon.png">
        <link rel="stylesheet" href="css/main.css">
        <link rel="stylesheet" href="css/normalize.css">
    </head>
    <body class="doctor-page">
        <div class="chat-container">
            <div class="chat-header" id="chatHeader" >
                Chat with Patient
            </div>
            <div class="chat-messages" id="chatMessages">
                </div>
            <div class="chat-input">
                <button type="button" onclick="document.getElementById('fileInput').click()">Attach File</button>
                <input type="file" style="display: none;"  id="fileInput" onchange="uploadFile()">
                <input type="text" id="messageInput" placeholder="Type your reply..." />
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>

        <script>
            function getDoctorName() {
                let params = new URLSearchParams(window.location.search);
                return params.get('doctor') || 'Doctor';
            }

            const patientName = 'Patient';

            document.addEventListener("DOMContentLoaded", () => {
                const doctorName = getDoctorName();
                document.querySelector(".chat-header").textContent = `Chat with ${patientName}`;
                loadMessages(doctorName, patientName);
                setInterval(() => loadMessages(doctorName, patientName), 1000);

                // Clear Chat when restart the page
                window.addEventListener('beforeunload', () => {
                    const doctorName = getDoctorName();
                    const conversationKey = `chat-with-${doctorName}-and-${patientName}`;
                    localStorage.removeItem(conversationKey);
                });
            });

            function loadMessages(doctorName, patientName) {
                const chatMessages = document.getElementById("chatMessages");
                chatMessages.innerHTML = '';
                const conversationKey = `chat-with-${doctorName}-and-${patientName}`;
                const messages = JSON.parse(localStorage.getItem(conversationKey)) || [];
                messages.forEach(msg => {
                    const msgDiv = document.createElement("div");
                    msgDiv.className = `message ${msg.type}`;
                    msgDiv.textContent = msg.text;
                    if (msg.file) {
                        const fileDiv = document.createElement("div");
                        fileDiv.className = 'file-message';
                        fileDiv.textContent = `Attached file: ${msg.file}`;
                        msgDiv.appendChild(fileDiv);
                    }
                    chatMessages.appendChild(msgDiv);
                });
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            function sendMessage() {
                const input = document.getElementById("messageInput");
                const message = input.value.trim();
                const doctorName = getDoctorName();
                if (message !== "") {
                    const newMessage = { text: message, type: 'doctor' };
                    const conversationKey = `chat-with-${doctorName}-and-${patientName}`;
                    let messages = JSON.parse(localStorage.getItem(conversationKey)) || [];
                    messages.push(newMessage);
                    localStorage.setItem(conversationKey, JSON.stringify(messages));
                    input.value = "";
                    loadMessages(doctorName, patientName);
                }
            }

            function uploadFile() {
                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                const doctorName = getDoctorName();

                if (file) {
                    const newMessage = {
                        text: 'Doctor attached a file',
                        type: 'doctor',
                        file: file.name
                    };
                    const conversationKey = `chat-with-${doctorName}-and-${patientName}`;
                    let messages = JSON.parse(localStorage.getItem(conversationKey)) || [];
                    messages.push(newMessage);
                    localStorage.setItem(conversationKey, JSON.stringify(messages));
                    loadMessages(doctorName, patientName);
                    fileInput.value = ""; // Clear the file input
                }
            }
        </script>
    </body>
</html>